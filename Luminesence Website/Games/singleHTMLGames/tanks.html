<!DOCTYPE html><html><head><title>Roll Tanks</title><meta name="language" content="en"><meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1"><meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="default"><script type="text/javascript">function init(){window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(audioCtx=new window.AudioContext),state=Const.STATE_INIT,cv=document.getElementById("game"),cvRect=cv.getBoundingClientRect(),ctx=cv.getContext("2d",{alpha:!1}),ctx.webkitImageSmoothingEnabled=!1,bg=ctx.createLinearGradient(0,0,0,720),bg.addColorStop(0,"#9DDAEC"),bg.addColorStop(1,"#3D81C0"),ratio=cv.width/cv.height,resize(),mPos={x:0,y:0},cv.addEventListener("mousemove",msMv,!1),cv.addEventListener("mousedown",msDn,!1),cv.addEventListener("mouseup",msUp,!1),cv.addEventListener("touchmove",tMv,!1),cv.addEventListener("touchstart",tDn,!1),cv.addEventListener("touchend",tUp,!1),cv.addEventListener("keydown",onKeyDown,!1),cv.addEventListener("keyup",onKeyUp,!1),setInterval(update,1e3/Const.FPS),game=new Game(!0),game.init(),trans=new Transition,state=Const.STATE_GAME}function resize(){cv.height=window.innerHeight,cv.width=cv.height*ratio,originX=(window.innerWidth-cv.width)/2,cv.style.left=originX+"px",cv.style.position="absolute",scale=cv.width/Const.W;var a=document.getElementById("rotate"),b=document.getElementById("holder");window.innerWidth<window.innerHeight?(a.style.display="block",b.style.display="none",isPortrait=!0):(a.style.display="none",b.style.display="block",isPortrait=!1)}function onKeyDown(a){state==Const.STATE_GAME&&game.keyDn(a.keyCode)}function onKeyUp(a){state==Const.STATE_GAME&&game.keyUp(a.keyCode)}function msMv(a){mPos=getmPos(cv,a),isMsDn&&state==Const.STATE_GAME&&game.hud.touch.press(mPos.x,mPos.y)}function msDn(a){isMsDn=!0,state==Const.STATE_GAME&&game.msDn()}function msUp(a){isMsDn=!1,state==Const.STATE_GAME&&game.msUp()}function tMv(a){a.preventDefault(),mPos=tPos(cv,a),isMsDn&&state==Const.STATE_GAME&&game.hud.touch.press(mPos.x,mPos.y)}function tDn(a){a.preventDefault(),mPos=tPos(cv,a),isMsDn=!0,state==Const.STATE_GAME&&(mPos.x<.5*Const.W*scale?game.msDn(1):game.msDn(2))}function tUp(a){isMsDn=!1,a.preventDefault(),mPos=tPos(cv,a),state==Const.STATE_GAME&&(isTouch=!0,mPos.x<.5*Const.W*scale?game.msUp(1):game.msUp(2))}function tPos(a,b){return{x:b.changedTouches[0].pageX-a.offsetLeft,y:b.changedTouches[0].pageY-a.offsetTop}}function getmPos(a,b){return{x:b.pageX-a.offsetLeft,y:b.pageY-a.offsetTop}}function startGame(){transFunc=onTransGame,trans.start()}function quitGame(){transFunc=onTransQuit,trans.start()}function onTransQuit(){game=new Game(!0),game.init()}function onTransGame(){game=new Game(!1),game.init()}function rnd(){return Math.random()}function getProjectilePos(a,b){var c=160;return{x:c*b*Math.cos(a),y:c*b*Math.sin(a)-.5*Const.G*(b*b)*-2}}function getProjectileRange(a){var b=160;return b*b*Math.sin(2*a*Const.D2R)/(2*Const.G)}function addBox(a,b,c,d,e,f,g,h,i,j,k,l){tW=j||e,tH=k||f,tD=l||g;var m=[[b-tW/2,c-f/2,d-tD/2],[b+tW/2,c-f/2,d-tD/2],[b+tW/2,c-f/2,d+tD/2],[b-tW/2,c-f/2,d+tD/2],[b-e/2,c+f/2,d-g/2],[b+e/2,c+f/2,d-g/2],[b+e/2,c+f/2,d+g/2],[b-e/2,c+f/2,d+g/2]];if(h.length<6){var n="#fff";h.length>0&&(n=h[0]),h=[n,n,n,n,n,n]}""!=h[0]&&addQuad(a,m[0],m[1],m[2],m[3],h[0],i),""!=h[1]&&addQuad(a,m[4],m[5],m[6],m[7],h[1],i),""!=h[2]&&addQuad(a,m[0],m[1],m[5],m[4],h[2],i),""!=h[3]&&addQuad(a,m[3],m[2],m[6],m[7],h[3],i),""!=h[4]&&addQuad(a,m[0],m[3],m[7],m[4],h[4],i),""!=h[5]&&addQuad(a,m[1],m[2],m[6],m[5],h[5],i)}function addQuad(a,b,c,d,e,f,g,h){a.qd.push([addSprite(a,b[0],b[1],b[2],f,10,1,0,g,h),addSprite(a,c[0],c[1],c[2],f,10,1,1,g,h),addSprite(a,d[0],d[1],d[2],f,10,0,1,g,h),addSprite(a,e[0],e[1],e[2],f,10,0,0,g,h)])}function addSprite(a,b,c,d,e,f,g,h,i,j){var k=new SceneObject(e,f);return k.x=b+a.x,k.y=c+a.y,k.z=d+a.z,k.u=g||0,k.v=h||0,k.lr=i||0,k.a=j||1,a.pt.push(k),k}function rotate(a,b,c,d){var e,f,g,h=a.uR.length,i=Math.sin(d),j=Math.cos(d);for(g=0;g<h;g++)e=a.uR[g].x,f=a.uR[g].y,a.zR[g].x=e*j-f*i,a.zR[g].y=f*j+e*i,a.zR[g].z=a.uR[g].z;for(i=Math.sin(b),j=Math.cos(b),g=0;g<h;g++)f=a.zR[g].y,z=a.zR[g].z,a.xR[g].x=a.zR[g].x,a.xR[g].y=f*j-z*i,a.xR[g].z=z*j+f*i;for(i=Math.sin(c),j=Math.cos(c),g=0;g<h;g++)e=a.xR[g].x,z=a.xR[g].z,a.yR[g].x=e*j+z*i,a.yR[g].y=a.xR[g].y,a.yR[g].z=z*j-e*i}function update(){ctx.clearRect(0,0,cv.width,cv.height),game&&game.update(mPos.x,mPos.y),trans&&trans.update()}function drawText(a,b,c,d,e,f,g){ctx.font="bold "+Math.floor(d*scale)+"px Arial",ctx.textAlign=g||"center",e>0&&(ctx.fillStyle="#000",ctx.fillText(a,Math.floor(b*scale),Math.floor((c+e)*scale))),ctx.fillStyle=f||"#fff",ctx.fillText(a,Math.floor(b*scale),Math.floor(c*scale))}var Arc=function(a){this.anc=a,this.x=a.x,this.y=a.y,this.z=a.z,this.px=this.py=0,this.dist=0,this.scale=this.locSc=1,this.vis=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.rx=this.ry=this.rz=0;var b;for(b=0;b<20;b++)addSprite(this,0,0,100*b,"#FF0000",48);for(b=0;b<this.pt.length;b++){var c=this.pt[b].x-this.x,d=this.pt[b].y-this.y,e=this.pt[b].z-this.z;this.uR.push({x:c,y:d,z:e}),this.zR.push({x:c,y:d,z:e}),this.yR.push({x:c,y:d,z:e}),this.xR.push({x:c,y:d,z:e}),this.pt[b].hid=!0}};Arc.prototype={setScale:function(a){this.scale=a},setVisible:function(a){for(var b=0;b<this.pt.length;b++)this.pt[b].hid=!a},update:function(a,b,c){var d;for(this.x=this.anc.x,this.y=this.anc.y,this.z=this.anc.z,d=0;d<this.pt.length;d++){var e=getProjectilePos(-a*Const.D2R,d+1);this.uR[d].z=e.x,this.uR[d].y=e.y,e.y+this.y>-50?this.pt[d].hid=!0:this.pt[d].hid=!1}for(rotate(this,this.rx*Const.D2R,(this.ry+b)*Const.D2R,(this.rz+c)*Const.D2R),d=0;d<this.pt.length;d++)this.pt[d].x=this.yR[d].x+this.x,this.pt[d].y=this.yR[d].y+this.y,this.pt[d].z=this.yR[d].z+this.z}};var Button=function(a,b,c,d,e){this.x=a||0,this.y=b||0,this.w=this.h=c,this.hw=c/2,this.vis=!0,this.isOv=!1,this.alpha=1,this.col=""==e?"":e||"#666",this.t=d||""};Button.prototype={click:function(a,b){return!!this.vis&&(a>this.getX()&&a<this.getX()+this.getW()&&b>this.getY()&&b<this.getY()+this.getH())},press:function(a,b){if(!this.vis)return!1;a>this.getX()&&a<this.getX()+this.getW()&&b>this.getY()&&b<this.getY()+this.getH()&&(this.isDn=!0)},release:function(){this.isDn=!1},getX:function(){return this.x*scale},getY:function(){return this.y*scale},getW:function(){return this.w*scale},getH:function(){return this.h*scale},update:function(a,b){this.isOv?(a<this.getX()||a>this.getX()+this.getW()||b<this.getY()||b>this.getY()+this.getH())&&(this.isOv=!1,this.isDn=!1):a>this.getX()&&a<this.getX()+this.getW()&&b>this.getY()&&b<this.getY()+this.getH()&&(this.isOv=!0)},draw:function(){if(this.vis){var a=this.isOv?4:0;this.isOv||(ctx.globalAlpha=.25,ctx.beginPath(),ctx.arc(Math.floor((this.x+this.hw)*scale),Math.floor((this.y+(this.hw+4))*scale),Math.floor(this.hw*scale),0,Const.PI2),ctx.strokeStyle="#000",ctx.lineWidth=Math.floor(.2*this.hw*scale),ctx.stroke(),ctx.globalAlpha=1),ctx.globalAlpha=this.alpha,ctx.beginPath(),ctx.arc(Math.floor((this.x+this.hw)*scale),Math.floor((this.y+this.hw+a)*scale),Math.floor(this.hw*scale),0,Const.PI2),""!=this.col&&(ctx.fillStyle=this.col,ctx.fill()),ctx.strokeStyle="#fff",ctx.fillStyle="#fff",ctx.lineWidth=Math.floor(.2*this.hw*scale),ctx.stroke(),">"==this.t||"X"==this.t||"II"==this.t?(ctx.save(),ctx.translate(Math.floor((this.x+this.hw)*scale),Math.floor((this.y+a+this.hw)*scale)),">"==this.t?(ctx.scale(.5*scale,.5*scale),ctx.fill(new Path2D(d="M50 0L-30-50-30 50 50 0"))):"X"==this.t?(ctx.scale(.55*scale,.55*scale),ctx.fill(new Path2D(d="M25-46L0-21-25-46-46-25-21 0-46 25-25 46 0 21 25 46 46 25 21 0 46-25 25-46"))):"II"==this.t&&(ctx.scale(.3*scale,.3*scale),ctx.fill(new Path2D(d="M40-45L10-45 10 45 40 45 40-45")),ctx.fill(new Path2D(d="M-10-45L-40-45-40 45-10 45-10-45"))),ctx.restore()):""!=this.t&&(ctx.font=Math.floor(this.hw*scale)+"px Arial",ctx.textAlign="center",ctx.fillText(this.t,Math.floor((this.x+this.hw)*scale),Math.floor((this.y+a+.66*this.w)*scale))),ctx.globalAlpha=1}}};var Cloud=function(a){this.x=this.y=this.z=this.px=this.py=0,this.dist=0,this.w=this.h=a/2,this.h=a/2,this.scale=1,this.ox=-.5*this.w,this.oy=-.5*this.h,this.locSc=1,this.lr=-4};Cloud.prototype={setScale:function(a,b){this.scale=a,this.scaleY=b||a,this.ox=this.w*this.scale*-.5,this.oy=this.h*this.scaleY*-.5},draw:function(){this.py+=30,this.w*this.scale*scale>0&&this.px<Const.W+100&&this.px>-100&&(ctx.beginPath(),ctx.arc((this.px+this.ox)*scale,(this.py+this.oy-32)*scale,this.w*this.scale*scale,.9*Math.PI,2.1*Math.PI),ctx.fillStyle="#fff",ctx.fill())}};var Clouds=function(a,b){this.x=a,this.z=b,this.r=5e4,this.vis=!0,this.hid=!1,this.sky=null,this.clouds=[]};Clouds.prototype={init:function(a){this.sky=new Sky,this.sky.vis=!0,this.sky.px=840,this.sky.setScale(1680,1.5);var b,c=2*Math.PI/40;for(b=0;b<40;b++){var d=8e3+Math.floor(1e4*rnd()),e=new Cloud(d);e.x=Math.cos(c*b)*this.r,e.y=0,e.z=-Math.sin(c*b)*this.r,this.clouds.push(e),a.push(e)}},update:function(a,b){for(var c=2*Math.PI/40,d=0,e=999999,f=0;f<this.clouds.length;f++)if(game.isLkDn?this.clouds[f].hid=!0:this.clouds[f].hid=!1,this.clouds[f].x=a+Math.cos(c*f)*this.r,this.clouds[f].z=b-Math.sin(c*f)*this.r,this.clouds[f].vis){var g=Math.abs(this.clouds[f].px-this.sky.px);g<e&&(e=g,d=f)}this.sky.py=this.clouds[d].py}},Col={circle:function(a,b,c,d,e,f){var g=d-a,h=e-b;return g*g+h*h-(c+f)*(c+f)},aabb:function(a,b,c,d,e,f,g,h){var i=a-.5*c,j=a+.5*c,k=b-.5*d,l=b+.5*d,m=e-.5*g,n=e+.5*g,o=f-.5*h,p=f+.5*h;return!(i>n||j<m||k>p||l<o)}},Const={STATE_INIT:0,STATE_GAME:3,W:1680,H:720,FPS:30,D2R:.0174532925,R2D:57.295779513,PI2:6.2831853,G:9.81};var menu,game,trans,transFunc,cv=null,cvRect=null,ctx=null,audioCtx=null,state,scale,ratio,originX,isMsDn=!1,mPos,buttons=[];window.onload=init,window.addEventListener("resize",resize,!1);var isTouch=!1,isPortrait=!1,bg=null,lev=1,ts=0,frame=0,Dice=function(a,b,c){this.x=a,this.y=b,this.z=c,this.px=this.py=0,this.dist=0,this.scale=1,this.locSc=1,this.vis=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.rx=this.ry=this.rz=0,this.numbers=[{x:0,y:90,z:0},{x:-90,y:90,z:0},{x:0,y:180,z:90},{x:90,y:90,z:0},{x:180,y:90,z:0}],this.value=0,this.rC=-1,this.enabled=!1,this.dy=50,this.btn=new Button(0,0,160,""),addBox(this,0,0,0,300,300,300,["#F29AC0","#F29AC0","#FEDDB4","#FEDDB4","#EDEDA5","#EDEDA5"],2),addBox(this,0,0,0,300,300,300,["0","4","1","-3","-2","2"],2);for(var d=0;d<this.pt.length;d++){var e=this.pt[d].x-this.x,f=this.pt[d].y-this.y,g=this.pt[d].z-this.z;this.uR.push({x:e,y:f,z:g}),this.zR.push({x:e,y:f,z:g}),this.yR.push({x:e,y:f,z:g}),this.xR.push({x:e,y:f,z:g})}};Dice.prototype={setScale:function(a){this.scale=a},click:function(a,b){!this.hid&&this.enabled&&this.btn.click(a,b)&&(this.setVisible(!1),this.enabled=!1,game.setStat(this.value))},setVisible:function(a){for(var b=0;b<this.pt.length;b++)this.pt[b].hid=!a},roll:function(){this.setVisible(!0),this.value=Math.floor(5*rnd()),this.rx=this.numbers[this.value].x,this.ry=this.numbers[this.value].y+40*rnd()-20,this.rz=this.numbers[this.value].z,this.y=-2e3,this.rx-=500,this.ry-=250,this.rC=0},update:function(a,b){this.rC>=0&&this.rC<50?(this.rx+=10,this.ry+=5,this.rC++):(-1!=this.rC&&game.enableTanks(),this.rC=-1),this.y+=this.dy,this.dy+=5,this.y>-200&&(this.y=-200,this.dy*=-.25,this.dy<0&&this.dy>-.1&&(this.dy=0)),rotate(this,this.rx*Const.D2R,this.ry*Const.D2R,this.rz*Const.D2R);for(var c,c=0;c<this.pt.length;c++)this.pt[c].x=this.yR[c].x+this.x,this.pt[c].y=this.yR[c].y+this.y,this.pt[c].z=this.yR[c].z+this.z;this.btn.x=this.px-80,this.btn.y=this.py-80,this.btn.update(a,b)}};var Explosion=function(){for(this.x=this.y=this.z=this.px=this.py=0,this.dist=0,this.scale=this.locSc=1,this.vis=this.hid=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.exploding=!1,addSprite(this,0,0,0,"#fff",512,0,0,0,.5),i=0;i<this.pt.length;i++){var a=this.pt[i].x-this.x,b=this.pt[i].y-this.y,c=this.pt[i].z-this.z;this.uR.push({x:a,y:b,z:c}),this.zR.push({x:a,y:b,z:c}),this.yR.push({x:a,y:b,z:c}),this.xR.push({x:a,y:b,z:c})}this.setVisible(!1)};Explosion.prototype={setScale:function(a){this.scale=a},setVisible:function(a){for(var b=0;b<this.pt.length;b++)this.pt[b].hid=!a},explode:function(a,b,c){for(this.x=a,this.y=b,this.z=c,n=0;n<this.pt.length;n++)this.pt[n].x=this.yR[n].x+this.x,this.pt[n].y=this.yR[n].y+this.y,this.pt[n].z=this.yR[n].z+this.z;this.t=0,this.exploding=!0,this.setVisible(!0)},update:function(){if(this.exploding){this.t+=.333,t>10&&(this.exploding=!1);for(var a=0;a<this.pt.length;a++)this.pt[a].x=this.yR[a].x+this.x,this.pt[a].y=this.yR[a].y+this.y,this.pt[a].z=this.yR[a].z+this.z}}};var Floor=function(){this.x=0,this.y=-50,this.z=0,this.px=this.py=0,this.dist=0,this.scale=1,this.locSc=1,this.vis=!0,this.pt=[],this.qd=[],this.edgeStart;for(var a,b="#9CC841",c="#F58023",d=-5;d<5;d++)for(var e=-5;e<5;e++)a=(d+e)%2==0?b:"#BDD549",addQuad(this,[200*d-0,0,200*e-0],[200*d+200,0,200*e-0],[200*d+200,0,200*e+200],[200*d-0,0,200*e+200],a,-2);this.edgeStart=this.qd.length,addBox(this,0,12.5,0,2e3,25,2e3,["","",b,b,b,b],-3),addBox(this,0,62.5,0,2e3,75,2e3,["","",c,c,c,c],-3)};Floor.prototype={setScale:function(a){this.scale=a},update:function(){for(var a=this.edgeStart;a<this.qd.length;a++)for(var b=0;b<this.qd[a].length;b++)game.isLkDn?this.qd[a][b].hid=!0:this.qd[a][b].hid=!1}};var Game=function(a){this.title=a,this.isRunning=!0,this.objs=[],this.qd=[],this.cam={x:0,y:0,z:0,ry:0,rx:0},this.isLkDn=!1,this.isMapCam=!0,this.mapCam={x:0,y:-2e3,z:0,ry:0,rx:Math.PI/2},this.rxT=this.ryT=0,this.focalLength=800,this.p=null,this.dice=[],this.stats=["","",""],this.currStat=0,this.clouds=null,this.fl=[],this.trees=[],this.tm1=[],this.tm2=[],this.arc=null,this.shell=null,this.shad=null,this.exp=null,this.pUp=null,this.hud=new HUD,this.inputs=[0,0,0,0,0],this.inX=this.inY=0,this.gS=0,this.round=1,this.turn=1,this.currTank=-1,this.eTar=-1,this.eToR=0,this.eTD=1,this.eToL=0,this.eTL=1,this.eTurn=!0,this.tanksOn=!1,this.win=-1,this.getHealth=!1,this.autoplay=!1};Game.prototype={init:function(){var a=new Floor;for(this.fl.push(a),this.addObj(a),i=0;i<3;i++){var b=new Dice(600*i-600,-200,0);this.dice.push(b),this.addObj(b),b.setVisible(!1)}this.clouds=new Clouds(0,0),this.clouds.init(this.objs);var c,d=this.title?[{x:-500,z:100,r:0}]:[{x:-500,z:-550,r:20},{x:500,z:-550,r:340},{x:-600,z:500,r:160},{x:600,z:500,r:200},{x:0,z:700,r:180}];for(i=0;i<d.length;i++)i<2?(c=new Tank(d[i].x,-30,d[i].z,"#EC1C5A"),this.tm1.push(c)):(c=new Tank(d[i].x,-30,d[i].z,"#644B9E"),c.enabled=c.btn.vis=!1,this.tm2.push(c)),c.ry=d[i].r,this.addObj(c),this.addObj(c.tur),this.addObj(c.tur.gun);var e=[{x:-100,z:200},{x:200,z:-200},{x:-400,z:-700},{x:-800,z:-200},{x:300,z:700},{x:700,z:-300},{x:0,z:-800},{x:200,z:-700},{x:800,z:800},{x:800,z:600}];for(i=0;i<e.length;i++){var f=Math.floor(5*rnd())+5;c=new Tree(e[i].x,-50,e[i].z,f),this.trees.push(c),this.addObj(c)}this.arc=new Arc(this.tm1[0].tur.gun.firePoint),this.arc.setVisible(!1),this.addObj(this.arc),this.shell=new Shell,this.addObj(this.shell),this.shad=new Shadow,this.shad.setVisible(!1),this.addObj(this.shad),this.exp=new Explosion,this.addObj(this.exp),this.pUp=new Health(0,0),this.addObj(this.pUp),this.title&&(this.pUp.setVisible(!1),this.bPlay=new Button(785,330,110,">"))},addObj:function(a){var b;for(b=0;b<a.pt.length;b++)this.objs.push(a.pt[b]);if(a.qd)for(b=0;b<a.qd.length;b++)this.qd.push(a.qd[b])},drawObj:function(a){var b,c,d,e,f,g;b=a.x-this.cam.x,c=a.y-this.cam.y,d=a.z-this.cam.z;var h=this.cam.ry/2;e=Math.cos(h)*b-Math.sin(h)*d,g=Math.sin(h)*b+Math.cos(h)*d,b=e,d=g,h=this.cam.rx,f=Math.cos(h)*c-Math.sin(h)*d,g=Math.sin(h)*c+Math.cos(h)*d,c=f,d=g,a.dist=d;var i=this.focalLength/(this.focalLength+d);a.lockX||(a.px=b*i+840),a.py=c*i+360,a.lockScale||a.setScale(i),a.hid?a.vis=!1:d>0||Math.abs(d)<800?a.vis=!(a.px>Const.W+300||a.px<-300||a.py>Const.H+500||a.py<-500):a.vis=!1},action:function(){if(2!=this.turn)if(1==this.gS)this.gS=2,this.hud.currPrompt++,this.setArcVisible(!0);else if(2==this.gS){this.hud.currPrompt=0,this.setArcVisible(!1);var a=Math.floor(rnd()*this.stats[1]*2)-this.stats[1],b=Math.floor(rnd()*this.stats[1]*2)-this.stats[1];this.shell.fire(this.arc.x,this.arc.y,this.arc.z,this.p.rx+this.p.tur.rx+this.p.tur.gun.rx+a,this.p.ry+this.p.tur.ry+this.p.tur.gun.ry+b),this.shad.setVisible(!0),this.gS=0}},setArcVisible:function(a){a&&(this.arc.anc=this.p.tur.gun.firePoint),this.arc.setVisible(a)},roll:function(){this.tanksOn=!1;for(var a=0;a<this.dice.length;a++)this.dice[a].roll();if(this.exp.setVisible(!1),1==this.turn)for(a=0;a<this.tm1.length;a++)this.tm1[a].sd=0;else for(a=0;a<this.tm2.length;a++)this.tm2[a].sd=0;this.pUp.setVisible(!0)},collectHealth:function(a){if(a.hp<1&&a.hp>0){a.hp+=.1;for(var b,c=!0;c;){this.pUp.x=1e3*rnd()-450,this.pUp.z=1e3*rnd()-450;var d=!1;for(Col.aabb(a.x,a.z,1e3,1e3,this.pUp.x,this.pUp.z,50,50)&&(d=!0),b=0;b<this.fl.length;b++)Col.aabb(this.x,this.z,0,0,game.fl[b].x,game.fl[b].z,1850,1850)||(d=!0);for(b=0;b<this.tm1.length;b++)Col.aabb(this.tm1[b].x,this.tm1[b].z,250,250,this.pUp.x,this.pUp.z,50,50)&&(d=!0);for(b=0;b<this.tm2.length;b++)Col.aabb(this.tm2[b].x,this.tm2[b].z,250,250,this.pUp.x,this.pUp.z,50,50)&&(d=!0);for(b=0;b<game.trees.length;b++)Col.aabb(game.trees[b].x,game.trees[b].z,50,50,this.pUp.x,this.pUp.z,50,50)&&(d=!0);c=d}this.pUp.setVisible(!1)}},onShot:function(){this.win<0&&(this.p=null,this.stats=["","",""],++this.turn>2&&(this.turn=1,this.round++),this.isMapCam=!0,this.hud.t=0)},explode:function(a,b,c){this.exp.explode(a,b,c),this.damage(a,c,this.tm1),this.damage(a,c,this.tm2),this.shad.setVisible(!1)},damage:function(a,b,c){var d,e,f;for(d=0;d<c.length;d++)(e=Col.circle(c[d].x,c[d].z,1,a,b,256))<=0&&(f=Math.sqrt(Math.abs(e))/512,c[d].sd>0&&(c[d].sd-=f,c[d].sd<0&&(f=-1*c[d].sd,c[d].sd=0),c[d].sd=c[d].sd),c[d].hp>0&&(c[d].hp=Math.max(0,c[d].hp-f),c[d].hp<=0&&this.kill(c[d])))},kill:function(a){a.setVisible(!1);var b,c=0,d=0;for(b=0;b<this.tm1.length;b++)c+=this.tm1[b].hp;for(b=0;b<this.tm2.length;b++)d+=this.tm2[b].hp;c<=0?this.result(0):d<=0&&this.result(1)},result:function(a){this.win=a,this.hud.t2=0},setKey:function(a,b){37==a||65==a||81==a?this.inputs[2]=-b:39==a||68==a?this.inputs[3]=b:38==a||87==a||90==a?this.inputs[0]=-b:40!=a&&83!=a||(this.inputs[1]=b),32==a&&(this.inputs[4]||this.action(),this.inputs[4]=b)},setInputs:function(){this.inX=this.inputs[2]+this.inputs[3],this.inY=this.inputs[0]+this.inputs[1]},keyDn:function(a){this.setKey(a,1),this.setInputs()},keyUp:function(a){this.setKey(a,0),this.setInputs()},msDn:function(){this.hud.press(mPos.x,mPos.y)},msUp:function(){this.bPlay&&this.bPlay.click(mPos.x,mPos.y)&&(lev=2,startGame()),this.hud.click(mPos.x,mPos.y),this.hud.release();var a;for(a=0;a<this.dice.length;a++)this.dice[a].click(mPos.x,mPos.y);for(a=0;a<this.tm1.length;a++)this.tm1[a].click(mPos.x,mPos.y)},enableTanks:function(){if(!this.tanksOn){this.tanksOn=!0,this.getHealth=!1;var a,b,c,d=this.tm1.length;if(1!=this.turn||this.autoplay){var e=1==this.turn?this.tm2:this.tm1,f=1==this.turn?this.tm1:this.tm2;for(d=e.length,this.eTar=Math.floor(rnd()*d),this.eTurn=!0,a=0;a<d;a++)(e[a].hp<e[this.eTar].hp||e[this.eTar].hp<=0)&&e[a].hp>0&&(this.eTar=a);var g,h,i=0;for(a=0;a<f.length;a++){if(f[a].hp<=.5&&f[a].hp>0){i=a;break}f[a].hp>0&&(g=new Vector2D(f[i].x-e[this.eTar].x,f[i].x-e[this.eTar].x),h=new Vector2D(f[a].x-e[this.eTar].x,f[a].x-e[this.eTar].x),(h.magnitude()<g.magnitude()||f[i].hp<=0)&&(i=a))}this.p=f[i];var j=!1;for(a=0;a<360;a++){var k=1500,l=new Vector2D;l.vector(a);var m=!1;for(b=1;b<k;b+=50){var n=this.p.x+l.x*b,o=this.p.z-l.y*b;for(c=0;c<this.fl.length;c++)if(!Col.aabb(n,o,50,50,this.fl[c].x,this.fl[c].z,1850,1850)){m=!0;break}for(c=0;c<this.trees.length;c++)if(Col.aabb(n,o,100,100,this.trees[c].x,this.trees[c].z,100,100)){m=!0;break}if(!m){if(this.p.hp<.9&&Col.circle(n,o,1,this.pUp.x,this.pUp.z,100)<=0){this.eToR=a,this.eTD=this.p.ry>this.eToR?this.eTD=-1:1,this.getHealth=!0,j=!0;break}if(Col.circle(n,o,1,e[this.eTar].x,e[this.eTar].z,400)<=0){this.eToR=a,this.eTD=this.p.ry>this.eToR?this.eTD=-1:1,this.getHealth=!1,j=!0;break}}}if(j)break}for(j||console.log("path not found"),a=0;a<3;a++)this.selectDice(a)}else{for(a=0;a<d;a++)this.tm1[a].hp>0&&(this.tm1[a].enabled=this.tm1[a].btn.vis=!0);this.hud.currPrompt=1}}},selectDice:function(a){var b=this,c=[0,1,2];c.sort(function(a,c){return b.dice[a].value-b.dice[c].value}),c.reverse();var d=c[2];c[2]=c[1],c[1]=d,setTimeout(function(){b.setStat(b.dice[c[a]].value),b.dice[c[a]].setVisible(!1)},500*(a+1))},enableDice:function(){var a;for(this.tanksOn=!1,a=0;a<this.dice.length;a++)this.dice[a].enabled=!0},selectTank:function(a){this.p=a;for(var b=0;b<this.tm1.length;b++)this.tm1[b].enabled=this.tm1[b].btn.vis=!1;this.enableDice(),this.hud.setPrompt(2)},setStat:function(a){var b;if(this.stats[this.currStat]=a,2==this.currStat&&(this.p.sd=.1*a),this.currStat++,this.hud.currPrompt=this.currStat+2,this.currStat>2){for(game.isMapCam=!1,game.gS=1,this.currStat=0,b=0;b<this.tm1.length;b++)this.tm1[b].selected=!1;for(b=0;b<this.tm2.length;b++)this.tm2[b].selected=!1;this.hud.setPrompt(5)}},updateScene:function(){var a,b,c,d;for(this.clouds.update(0,0),a=0;a<this.objs.length;a++)this.drawObj(this.objs[a]);for(a=0;a<this.tm1.length;a++)this.drawObj(this.tm1[a]);for(a=0;a<this.tm2.length;a++)this.drawObj(this.tm2[a]);for(a=0;a<this.dice.length;a++)this.drawObj(this.dice[a]);this.drawObj(this.arc),this.drawObj(this.shell),this.drawObj(this.shad),this.drawObj(this.exp),this.drawObj(this.pUp),this.cam.rx<.5&&this.clouds.sky.draw(),this.objs.sort(this.zSort);var e=[];for(a=0;a<this.objs.length;a++){var f=!1;for(b=0;b<this.qd.length;b++){var g=!1;for(c=0;c<4;c++)if(this.objs[a]==this.qd[b][c]){for(d=0;d<e.length;d++)if(b==e[d]){g=!0,f=!0;break}if(g)break;this.drawQuad(this.qd[b],!1),e.push(b),f=!0;break}}f||this.objs[a].draw()}},drawQuad:function(a){var b;for(b=0;b<4;b++)if(!a[b].vis)return;if("#"!=a[0].col.charAt(0))return void this.drawTexturedQuad(a);for(ctx.fillStyle=a[0].col,a[0].a<1&&(ctx.globalAlpha=a[0].a),ctx.beginPath(),ctx.moveTo(Math.floor((a[3].px+a[3].ox)*scale),Math.floor((a[3].py+a[3].ox)*scale)),b=0;b<4;b++)ctx.lineTo(Math.floor((a[b].px+a[b].ox)*scale),Math.floor((a[b].py+a[b].ox)*scale));ctx.fill(),ctx.closePath(),a[0].a<1&&(ctx.globalAlpha=1)},drawTexturedQuad:function(a){var b,c,d=a[0].col,e=0,f=128,g=128,h=[[0,1,2],[2,3,0]];for("-"==d.charAt(0)&&(d=d.substr(1),e=1),isNaN(d)?"+"==d?(ctx.font="bold "+f+"px sans-serif",ctx.textAlign="center",ctx.fillStyle="#46BEA2"):(c=document.getElementById(d),f=c.width,g=c.height):(ctx.font="bold "+f+"px sans-serif",ctx.textAlign="center",ctx.fillStyle="#333"),b=0;b<2;b++){var i=h[b],j=(a[i[0]].px+a[i[0]].ox)*scale,k=(a[i[0]].py+a[i[0]].oy)*scale,l=(a[i[1]].px+a[i[1]].ox)*scale,m=(a[i[1]].py+a[i[1]].oy)*scale,n=(a[i[2]].px+a[i[2]].ox)*scale,o=(a[i[2]].py+a[i[2]].oy)*scale,p=Math.abs(a[i[0]].u-e)*f,q=Math.abs(a[i[1]].u-e)*f,r=Math.abs(a[i[2]].u-e)*f,s=a[i[0]].v*g,t=a[i[1]].v*g,u=a[i[2]].v*g;ctx.save(),ctx.beginPath(),ctx.moveTo(Math.floor(j),Math.floor(k)),ctx.lineTo(Math.floor(l),Math.floor(m)),ctx.lineTo(Math.floor(n),Math.floor(o)),ctx.closePath(),ctx.clip();var v=p*t+s*r+q*u-t*r-s*q-p*u,w=j*t+s*n+l*u-t*n-s*l-j*u,x=p*l+j*r+q*n-l*r-j*q-p*n,y=p*t*n+s*l*r+j*q*u-j*t*r-s*q*n-p*l*u,z=k*t+s*o+m*u-t*o-s*m-k*u,A=p*m+k*r+q*o-m*r-k*q-p*o,B=p*t*o+s*m*r+k*q*u-k*t*r-s*q*o-p*m*u;ctx.transform(w/v,z/v,x/v,A/v,y/v,B/v),isNaN(d)&&"+"!=d?ctx.drawImage(c,0,0):ctx.fillText(d,f/2,g-16),ctx.restore()}},zSort:function(a,b){return a.lr<b.lr?-1:a.lr>b.lr?1:b.dist-a.dist},update:function(a,b){var c,d=this;if(ctx.fillStyle=d.cam.rx>0?"#3D81C0":"#2A00F7",ctx.fillRect(0,0,1680*scale,720*scale),d.hud.update(a,b),d.title?d.tm1[0].update(a,b,1,-1):d.hud.touch.v&&(d.inX=d.inY=0,d.hud.touch.up.isDn&&(d.inY=-1),d.hud.touch.down.isDn&&(d.inY=1),d.hud.touch.left.isDn&&(d.inX=-1),d.hud.touch.right.isDn&&(d.inX=1)),d.isRunning){var e=0,f=0,g=1==d.turn?d.tm2:d.tm1;if(2==d.turn||d.autoplay)if(1==d.gS)if(d.eTurn)e=d.eTD,d.p.ry>=d.eToR-1&&d.p.ry<=d.eToR+1&&(e=0,d.eTurn=!1);else{f=-1;var h=!1;if(h=d.getHealth?Col.circle(d.p.x,d.p.z,1,d.pUp.x,d.pUp.z,120)<=0:Col.circle(d.p.x,d.p.z,1,g[d.eTar].x,g[d.eTar].z,500)<=0,d.stats[0]<=0&&(h=!0),h){var i=new Vector2D(-1*(d.p.x-g[d.eTar].x),d.p.z-g[d.eTar].z);d.eToR=Math.round(i.angle()+90),d.eToR<360&&(d.eToR+=360),d.eToR>=360&&(d.eToR-=360),d.eToR%2!=0&&d.eTor++;var j=d.p.tur.ry+d.p.ry;j>=360?j-=360:j<0&&(j+=360),d.eTD=j>d.eToR?-1:1;var k=99999;for(d.eToL=0,c=15;c<80;c++){var l=Math.abs(getProjectileRange(c)-i.magnitude());l<k&&(k=l,d.eToL=c)}d.eTL=d.p.rx+d.p.tur.rx+d.p.tur.gun.rx>d.eToL?-1:1,d.setArcVisible(!0),d.gS=2}}else if(2==d.gS){e=d.eTD,f=d.eTL;var j=d.p.tur.ry+d.p.ry;j>=360?j-=360:j<0&&(j+=360);var m=d.p.rx+d.p.tur.rx+d.p.tur.gun.rx;if(j>d.eToR-2&&j<d.eToR+2&&(e=d.eTD=0),m==d.eToL&&(f=d.eTL=0),j>=d.eToR-2&&j<=d.eToR+2&&m==d.eToL){e=f=0,d.setArcVisible(!1),d.gS=0;var n=this;setTimeout(function(){var a=Math.floor(rnd()*n.stats[1]*2)-n.stats[1],b=Math.floor(rnd()*n.stats[1]*2)-n.stats[1];n.shell.fire(n.arc.x,n.arc.y,n.arc.z,n.p.rx+n.p.tur.rx+n.p.tur.gun.rx+a,n.p.ry+n.p.tur.ry+n.p.tur.gun.ry+b),n.shad.setVisible(!0)},750)}}if(!d.title){for(c=0;c<d.tm2.length;c++)d.p==d.tm2[c]?d.tm2[c].update(a,b,e,f):d.tm2[c].update(a,b,0,0);for(c=0;c<d.tm1.length;c++)d.p==d.tm1[c]?d.autoplay?d.tm1[c].update(a,b,e,f):d.tm1[c].update(a,b,d.inX,d.inY):d.tm1[c].update(a,b,0,0)}for(2==d.gS&&d.arc.update(d.p.rx+d.p.tur.rx+d.p.tur.gun.rx,d.p.ry+d.p.tur.ry+d.p.tur.gun.ry,d.p.rz+d.p.tur.rz+d.p.tur.gun.rz),d.shell.update(),d.shad.update(d.shell),d.pUp.update(),c=0;c<d.trees.length;c++)d.trees[c].update();for(c=0;c<d.dice.length;c++)d.dice[c].update(a,b);for(c=0;c<d.fl.length;c++)d.fl[c].update();d.title?(d.xT=d.tm1[0].x+Math.sin(d.tm1[0].ry*Const.D2R),d.yT=d.tm1[0].y-260,d.zT=d.tm1[0].z+Math.cos(d.tm1[0].ry*Const.D2R),d.ryT=(d.tm1[0].ry+235)*Const.D2R,d.rxT=10*Const.D2R):d.isMapCam?(d.xT=d.mapCam.x,d.yT=d.mapCam.y,d.zT=d.mapCam.z,d.rxT=d.mapCam.rx,d.ryT=d.mapCam.ry):1==d.gS?(d.xT=d.p.x+-100*Math.sin(d.p.ry*Const.D2R),d.yT=d.p.y-300,d.zT=d.p.z+-100*Math.cos(d.p.ry*Const.D2R),d.ryT=d.p.ry*Const.D2R*2,d.rxT=-d.p.rx*Const.D2R):(d.xT=d.p.x+-400*Math.sin(d.p.ry*Const.D2R),d.yT=d.p.y-800,d.zT=d.p.z+-400*Math.cos(d.p.ry*Const.D2R),d.ryT=d.p.ry*Const.D2R*2,d.rxT=45*Const.D2R),d.cam.x+=(d.xT-d.cam.x)/10,d.cam.y+=(d.yT-d.cam.y)/10,d.cam.z+=(d.zT-d.cam.z)/10,d.cam.ry+=Const.R2D*Math.atan2(Math.cos(d.cam.ry*Const.D2R)*Math.sin(d.ryT*Const.D2R)-Math.sin(d.cam.ry*Const.D2R)*Math.cos(d.ryT*Const.D2R),Math.sin(d.cam.ry*Const.D2R)*Math.sin(d.ryT*Const.D2R)+Math.cos(d.cam.ry*Const.D2R)*Math.cos(d.ryT*Const.D2R))/10,d.cam.rx+=Const.R2D*Math.atan2(Math.cos(d.cam.rx*Const.D2R)*Math.sin(d.rxT*Const.D2R)-Math.sin(d.cam.rx*Const.D2R)*Math.cos(d.rxT*Const.D2R),Math.sin(d.cam.rx*Const.D2R)*Math.sin(d.rxT*Const.D2R)+Math.cos(d.cam.rx*Const.D2R)*Math.cos(d.rxT*Const.D2R))/10,d.isLkDn=d.cam.rx>.375*Math.PI}for(d.updateScene(),c=0;c<d.tm1.length;c++)d.tm1[c].draw();for(c=0;c<d.tm2.length;c++)d.tm2[c].draw();d.title?(drawText("ROLL",840,205,128,0,"#EC1C5A"),drawText("TANKS",840,305,100),drawText("2020 | David Durham | JS13K",840,700,24),d.bPlay.update(a,b),d.bPlay.draw()):d.hud.draw()}};var Health=function(a,b){this.x=a,this.y=-100,this.z=b,this.px=this.py=0,this.dist=0,this.scale=1,this.locSc=1,this.vis=!0,this.enabled=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.rx=this.ry=this.rz=0,addBox(this,0,-20,0,80,80,40,["#fff","","#ddd","#ddd","#ddd","#ddd"],0),addBox(this,0,-20,0,80,80,40,["","","+","+","",""],0),addQuad(this,[40,50,20],[-40,50,20],[-40,50,-20],[40,50,-20],"#000",-1,.2);for(var c=0;c<this.pt.length;c++){var d=this.pt[c].x-this.x,e=this.pt[c].y-this.y,f=this.pt[c].z-this.z;this.uR.push({x:d,y:e,z:f}),this.zR.push({x:d,y:e,z:f}),this.yR.push({x:d,y:e,z:f}),this.xR.push({x:d,y:e,z:f})}};Health.prototype={setScale:function(a){this.scale=a},setVisible:function(a){for(var b=0;b<this.pt.length;b++)this.pt[b].hid=!a;this.enabled=a},setPosition:function(a,b){this.x=a,this.z=b},update:function(){this.ry+=2,rotate(this,this.rx*Const.D2R,this.ry*Const.D2R,this.rz*Const.D2R);for(var a=0;a<this.pt.length;a++)this.pt[a].x=this.yR[a].x+this.x,this.pt[a].y=this.yR[a].y+this.y,this.pt[a].z=this.yR[a].z+this.z}};var HUD=function(){this.paused=new PausePanel(840,320);var a=Math.min(1680,(window.innerWidth-originX)*(1/scale));this.bPause=new Button(a-94,30,64,"II"),this.touch=new TouchControls,this.turnMessage=["PLAYER TURN","ENEMY TURN"],this.winMsg=["DEFEAT","VICTORY!"],this.prompt=["","Click on a RED tank to select it","Click on a dice to set FUEL level","Click on a dice to set firing INNACUARCY","Click on a dice to set SHIELD strength","Move with ARROW KEYS then press SPACEBAR","Aim then fire with the SPACEBAR"],this.promptT=["","Tap on a RED tank to select it","Tap a dice to set FUEL level","Tap a dice to set firing INACCURACY","Tap a dice to set SHIELD strength","Move with DIRECTION buttons then press ACTION button","Aim then fire with the ACTION button"],this.currPrompt=0,this.t=0,this.t2=5};HUD.prototype={setScore:function(a){this.score=a},click:function(a,b){this.bPause.click(a,b)&&(game.isRunning=!1,this.paused.vis=!0,this.bPause.vis=!1),this.paused.vis&&this.paused.click(a,b),this.touch.v&&this.touch.click(a,b)},press:function(a,b){this.touch.v&&this.touch.press(a,b)},release:function(){this.bPause.release(),this.touch.release()},setPrompt:function(a){this.currPrompt=a},draw:function(){if(this.paused.vis?this.paused.draw():(this.bPause.draw(),this.touch.draw()),this.t>1)if(this.t<=3){var a=Math.min(260*(8-3*this.t),260);a>0&&(ctx.fillStyle="#000",ctx.fillRect(0,(360-a/2)*scale,Math.min(1680,4e3*(this.t-1))*scale,a*scale)),this.t>1.5&&this.t<2.5&&(drawText(this.turnMessage[game.turn-1],840,360,96,0),drawText("Round "+game.round,840,440,48,0))}else this.t<4&&(this.t=5,game.roll());if(this.t2>1)if(this.t2<=3){var a=Math.min(260*(8-3*this.t2),260);a>0&&(ctx.fillStyle="#000",ctx.fillRect(0,(360-a/2)*scale,Math.min(1680,4e3*(this.t2-1))*scale,a*scale)),this.t2>1.5&&this.t2<2.5&&drawText(this.winMsg[game.win],840,400,128,0)}else this.t2<4&&(this.t2=5,quitGame());if(null!=game.p){var b=Math.max(0,1/scale*(0-originX));ctx.font="bold "+36*scale+"px Arial",ctx.textAlign="left",ctx.fillStyle="#fff",ctx.fillText("INACCURACY "+game.stats[1],(b+20)*scale,50*scale),game.stats[0]>0&&(drawText(Math.floor(game.stats[0]),b+20,680,200,0,"#fff","left"),drawText((1*game.stats[0]).toFixed(2).toString().substring(1),b+130,680,100,0,"#fff","left"))}if(1==game.round&&1==game.turn){var c=this.currPrompt<5?460:120;isTouch?drawText(this.promptT[this.currPrompt],840,c,36):drawText(this.prompt[this.currPrompt],840,c,36)}},update:function(a,b){this.paused.update(a,b),this.bPause.update(a,b),this.touch.update(a,b),this.t<5&&!game.title&&game.isMapCam&&(this.t+=.0333),this.t2<5&&(this.t2+=.0333)}};var PausePanel=function(a,b){this.x=a||0,this.y=b||0,this.w=480,this.h=240,this.ox=this.w/2,this.oy=this.h/2,this.vis=!1,this.bResume=new Button(this.x-50+80,this.y-25,100,">"),this.bQuit=new Button(this.x-50-80,this.y-25,100,"X")};PausePanel.prototype={click:function(a,b){this.bQuit.click(a,b)&&quitGame(),this.bResume.click(a,b)&&(game.isRunning=!0,this.vis=!1,game.hud.bPause.vis=!0)},draw:function(){this.vis&&(ctx.globalAlpha=.25,ctx.fillStyle="#000",ctx.fillRect(Math.floor((this.x-this.ox)*scale),Math.floor((this.y-this.oy+10)*scale),Math.floor(this.w*scale),Math.floor(this.h*scale)),ctx.globalAlpha=1,ctx.fillStyle="#444",ctx.fillRect(Math.floor((this.x-this.ox)*scale),Math.floor((this.y-this.oy)*scale),Math.floor(this.w*scale),Math.floor(this.h*scale)),drawText("PAUSED",this.x,this.y-60,48,0),this.bQuit.draw(),this.bResume.draw())},update:function(a,b){this.bQuit.update(a,b),this.bResume.update(a,b)}};var SceneObject=function(a,b,c){this.col=a,this.w=this.h=b/2,this.img=c||null,this.img&&(this.w=this.img.width,this.h=this.img.height),this.x=this.y=this.z=this.px=this.py=this.u=this.v=0,this.dist=0,this.scale=1,this.ox=-.5*this.w,this.oy=-.5*this.h,this.locSc=1,this.lr=0,this.a=1,this.vis=this.hid=!1}
;SceneObject.prototype={setScale:function(a,b){this.scale=a,this.scaleY=b||a,this.ox=this.w*this.scale*-.5,this.oy=this.h*this.scaleY*-.5},draw:function(){this.vis&&this.w*this.scale*scale>0&&(this.img?ctx.drawImage(this.img,(this.px+this.ox)*scale,(this.py+this.oy)*scale,this.img.width*this.scale*scale,this.img.height*this.scaleY*scale):""!=this.col&&(this.a<1&&(ctx.globalAlpha=this.a),ctx.beginPath(),ctx.arc(this.px*scale,this.py*scale,this.w*this.scale*scale,0,Const.PI2),ctx.fillStyle=this.col,ctx.fill(),ctx.closePath(),this.a<1&&(ctx.globalAlpha=1)))}};var Shadow=function(){for(this.x=this.y=this.z=this.px=this.py=0,this.dist=0,this.scale=1,this.vis=!0,this.hid=!0,this.ptO=[],this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.locSc=1,addQuad(this,[30,-50,30],[-30,-50,30],[-30,-50,-30],[30,-50,-30],"img_shadow",-1),i=0;i<this.pt.length;i++){this.ptO.push({x:this.pt[i].x,y:this.pt[i].y,z:this.pt[i].z});var a=this.pt[i].x-this.x,b=this.pt[i].y-this.y,c=this.pt[i].z-this.z;this.uR.push({x:a,y:b,z:c}),this.zR.push({x:a,y:b,z:c}),this.yR.push({x:a,y:b,z:c}),this.xR.push({x:a,y:b,z:c})}};Shadow.prototype={setScale:function(a){this.scale=a},setVisible:function(a){for(var b=0;b<this.pt.length;b++)this.pt[b].hid=!a},update:function(a){for(this.locSc=a.pt[0].y/250==0?1:1/(a.pt[0].y/250),this.x=a.pt[0].x,this.z=a.pt[0].z,n=0;n<this.pt.length;n++)this.pt[n].x=this.yR[n].x*this.locSc+this.x,this.pt[n].y=this.yR[n].y+this.y,this.pt[n].z=this.yR[n].z*this.locSc+this.z}};var Shell=function(){for(this.x=this.y=this.z=this.px=this.py=0,this.dist=0,this.scale=this.locSc=1,this.vis=!0,this.hid=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.startX=this.startY=this.startZ=0,this.rx=this.ry=0,this.firing=!1,this.hit=!1,addSprite(this,0,0,0,"#333",64),i=0;i<this.pt.length;i++){var a=this.pt[i].x-this.x,b=this.pt[i].y-this.y,c=this.pt[i].z-this.z;this.uR.push({x:a,y:b,z:c}),this.zR.push({x:a,y:b,z:c}),this.yR.push({x:a,y:b,z:c}),this.xR.push({x:a,y:b,z:c})}this.pt[0].hid=!0};Shell.prototype={setScale:function(a){this.scale=a},fire:function(a,b,c,d,e){this.x=this.startX=a,this.y=this.startY=b,this.z=this.startZ=c,this.rx=d,this.ry=e,this.t=0,this.firing=!0,this.hit=!1,this.pt[0].hid=!1},update:function(){if(this.firing){var a=getProjectilePos(-this.rx*Const.D2R,this.t);for(a.y-=30,this.yR[0].y=a.y,this.yR[0].x=a.x*Math.sin(this.ry*Const.D2R),this.yR[0].z=a.x*Math.cos(this.ry*Const.D2R),this.t+=.333,a.y>-30&&this.t>.5&&!this.hit&&(this.hit=!0,this.pt[0].hid=!0,game.explode(this.yR[0].x+this.x,this.yR[0].y+this.y,this.yR[0].z+this.z)),a.y>1e3?(this.t=0,this.firing=!1,game.onShot()):a.y>500&&game.exp.setVisible(!1),n=0;n<this.pt.length;n++)this.pt[n].x=this.yR[n].x+this.x,this.pt[n].y=this.yR[n].y+this.y,this.pt[n].z=this.yR[n].z+this.z}}};var Sky=function(){this.w=1,this.h=1024,this.px=this.py=0,this.scale=1,this.ox=-.5*this.w,this.oy=-.5*this.h};Sky.prototype={setScale:function(a,b){this.scale=a,this.scaleY=b||a,this.ox=this.w*this.scale*-.5,this.oy=this.h*this.scaleY*-.5},draw:function(){if(this.vis){var a=ctx.createLinearGradient((this.px+this.ox)*scale,(this.py+this.oy)*scale,(this.px+this.ox)*scale,(this.py+this.ox+this.h*this.scaleY)*scale);a.addColorStop(0,"#2A00F7"),a.addColorStop(.25,"#5D92F9"),a.addColorStop(.45,"#fff"),a.addColorStop(.5,"#fff"),a.addColorStop(.5,"#3D81C0"),a.addColorStop(1,"#3D81C0"),ctx.fillStyle=a,ctx.fillRect((this.px+this.ox)*scale,(this.py+this.oy)*scale,this.w*this.scale*scale,this.h*this.scaleY*scale)}}},SwipePrompt=function(){var a=this;if(this.enabled=!1,this.holder=document.getElementById("holder"),this.el=document.getElementById("sp"),this.spec=this.getSpec(),!this.spec)return void(this.el.style.visibility="hidden");this.height=this.spec[0],window.addEventListener("resize",function(b){a.onResize()}),this.el.addEventListener("touchend",function(b){a.enabled&&(a.showGame(),b.preventDefault(),b.returnValue=!1)}),this.onResize()},SwipePrompt.prototype={onResize:function(){window.innerHeight>window.innerWidth||window.innerHeight===this.height?(this.showGame(),window.scrollTo(0,0)):(this.showSwipePrompt(),window.scrollTo(0,0))},getSpec:function(){for(var a=[[320,480,2,"4"],[320,568,2,"5/SE"],[375,667,2,"6/7/8"],[414,736,3,"6/7/8 plus"],[375,812,3,"X/XS"],[414,896,3,"XS Max"],[414,896,2,"XR"]],b=0;b<a.length;b++){var c=a[b];if(window.screen.height==c[0]&&window.screen.width==c[1]||window.screen.width==c[0]&&window.screen.height==c[1])return c}return null},showSwipePrompt:function(){this.enabled=!0,this.holder.className=this.holder.className.replace("sp_disabled","sp_enabled"),this.el.style.visibility="visible",this.el.style.height="999999px",this.el.style.zIndex=999999,this.el.style.pointerEvents="all"},showGame:function(){this.el.removeEventListener("touchend",this.showGame),this.enabled=!1,this.holder.className=this.holder.className.replace("sp_enabled","sp_disabled"),this.el.style.visibility="hidden",this.el.style.height=this.height+1+"px",this.el.style.pointerEvents="none"}};var Tank=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.px=this.py=0,this.dist=0,this.scale=1,this.locSc=1,this.vis=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.rx=this.ry=this.rz=0,this.vx=new Vector2D,this.vy=new Vector2D,this.damp=.95,this.accel=this.speed=0,this.turnSpeed=2,this.moveSpeed=5,this.tur=null,this.btn=new Button(0,0,80,"",""),this.enabled=!1,this.selected=!1,this.hp=1,this.sd=0,this.hudAnc=null,this.init(d)};Tank.prototype={setScale:function(a){this.scale=a},setVisible:function(a){var b;for(b=0;b<this.pt.length;b++)this.pt[b].hid=!a;for(b=0;b<this.tur.pt.length;b++)this.tur.pt[b].hid=!a;for(b=0;b<this.tur.gun.pt.length;b++)this.tur.gun.pt[b].hid=!a},init:function(a){var b=addSprite(this,0,0,24,"",50),c="#666",d="#333",e="#444444";addBox(this,0,-64,0,88,40,104,[a,"",a,a,a,a]),addBox(this,0,-36,0,88,16,104,["","",c,c,c,c]),addBox(this,64,-40,36,32,40,56,[d,"",d,d,d,e]),addBox(this,64,-40,-36,32,40,56,[d,"",d,d,d,e]),addBox(this,-64,-40,36,32,40,56,[d,"",d,d,e,d]),addBox(this,-64,-40,-36,32,40,56,[d,"",d,d,e,d]),addQuad(this,[80,-20,80],[-80,-20,80],[-80,-20,-80],[80,-20,-80],"#000",-1,.2),this.hudAnc=addSprite(this,0,-150,0,"",50);for(var f=0;f<this.pt.length;f++){var g=this.pt[f].x-this.x,h=this.pt[f].y-this.y,i=this.pt[f].z-this.z;this.uR.push({x:g,y:h,z:i}),this.zR.push({x:g,y:h,z:i}),this.yR.push({x:g,y:h,z:i}),this.xR.push({x:g,y:h,z:i})}this.tur=new TankTurret(b)},click:function(a,b){this.enabled&&this.btn.click(a,b)&&(this.selected=!0,game.selectTank(this))},update:function(a,b,c,d){1==game.gS||game.title?game.stats[0]>0||game.title?(c>0?(this.ry+=1,this.ry>=360&&(this.ry-=360,game.cam.ry-=360*Const.D2R*2),game.stats[0]-=.005):c<0&&(this.ry-=1,this.ry<0&&(this.ry+=360,game.cam.ry+=360*Const.D2R*2),game.stats[0]-=.005),d>0?(this.accel=-.1,this.damp=.95,game.stats[0]-=.005):d<0?(this.accel=.1,this.damp=.95,game.stats[0]-=.005):(this.accel=0,this.damp=.85)):(game.stats[0]=0,game.gS=2,game.setArcVisible(!0)):2==game.gS&&(this.accel=0,this.damp=.85,c>0?(this.tur.ry+=2,this.tur.ry>360&&(this.tur.ry-=360)):c<0&&(this.tur.ry-=2,this.tur.ry<0&&(this.tur.ry+=360)),d>0?this.tur.gun.rx+=1:d<0&&(this.tur.gun.rx-=1)),this.speed+=this.accel,this.speed*=this.damp,rotate(this,this.rx*Const.D2R,this.ry*Const.D2R,this.rz*Const.D2R);for(var e,e=0;e<this.pt.length;e++)this.pt[e].x=this.yR[e].x+this.x,this.pt[e].y=this.yR[e].y+this.y,this.pt[e].z=this.yR[e].z+this.z;this.vx.vector(this.ry);var f=this.vx.x*this.speed*this.moveSpeed,g=this.vx.y*-this.speed*this.moveSpeed,h=0,i=!0;for(e=0;e<game.fl.length;e++)if(!Col.aabb(this.x+f,this.z+g,0,0,game.fl[e].x,game.fl[e].z,1850,1850)){i=!1;break}if(i)for(e=0;e<game.trees.length;e++)if(Col.aabb(this.x+f,this.z+g,150,150,game.trees[e].x,game.trees[e].z,50,50)){i=!1;break}i&&(this.x+=f,this.z+=g),Col.aabb(this.x,this.z,150,150,game.pUp.x,game.pUp.z,50,50)&&game.collectHealth(this);for(var e=0;e<this.pt.length;e++)this.pt[e].x+=f,this.pt[e].y+=h,this.pt[e].z+=g;this.tur.update(c,d,this.rx,this.ry,this.rz),this.btn.x=this.px-40,this.btn.y=this.py-40,this.btn.update(a,b)},draw:function(){this.selected&&game.isMapCam&&(ctx.beginPath(),ctx.arc(this.px*scale,this.py*scale,45*scale,0,Const.PI2),ctx.strokeStyle="#fff",ctx.lineWidth=10*scale,ctx.stroke()),!game.title&&this.hp>0&&(drawText(Math.ceil(10*this.hp),this.hudAnc.px+80,this.hudAnc.py,28,0,"#fff","left"),this.sd>0&&drawText(Math.ceil(10*this.sd),this.hudAnc.px+80,this.hudAnc.py+40,28,0,"#fff","left"),ctx.save(),ctx.translate((this.hudAnc.px+40)*scale,(this.hudAnc.py-22)*scale),ctx.scale(.3*scale,.3*scale),ctx.fillStyle="#EF5181",ctx.fill(new Path2D(d="M110 35Q110 18 99 8 90 1 79 1 75 1 69 3 61 6 56 12L55 13Q51 7 44 4 37 0 31 0 18 0 9 10 0 20 0 34 0 48 8 57 12 62 19 69 29 77 36 83 47 94 50 96 54 100 56 100 57 100 69 90 84 78 96 65 104 56 107 49 110 43 110 35")),ctx.restore(),this.sd>0&&(ctx.save(),ctx.translate((this.hudAnc.px+40)*scale,(this.hudAnc.py+16)*scale),ctx.scale(.3*scale,.3*scale),ctx.fillStyle="#8E56A1",ctx.fill(new Path2D(d="M103 12Q94 8 82 4 66 0 55 0 46 0 34 2 18 5 7 12L7 59Q5 73 39 98 44 101 51 107 54 110 56 110 56 110 65 103 78 92 86 86 95 79 100 71 103 64 103 60L103 12")),ctx.restore()))}};var TankGun=function(a){this.anc=a,this.x=a.x,this.y=a.y,this.z=a.z,this.px=this.py=0,this.dist=0,this.scale=this.locSc=1,this.vis=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.rx=game.title?10:60,this.ry=0,this.rz=0,this.firePoint=null,this.init()};TankGun.prototype={setScale:function(a){this.scale=a},init:function(){this.firePoint=addSprite(this,0,0,0,"",50),addBox(this,0,0,32,32,32,32,["#666","#666","","#444444","#666","#666"]);for(var a=0;a<this.pt.length;a++){var b=this.pt[a].x-this.x,c=this.pt[a].y-this.y,d=this.pt[a].z-this.z;this.uR.push({x:b,y:c,z:d}),this.zR.push({x:b,y:c,z:d}),this.yR.push({x:b,y:c,z:d}),this.xR.push({x:b,y:c,z:d})}},update:function(a,b,c,d){this.x=this.anc.x,this.y=this.anc.y,this.z=this.anc.z,this.rx<0?this.rx=0:this.rx>80&&(this.rx=80),rotate(this,(this.rx+b)*Const.D2R,(this.ry+c)*Const.D2R,(this.rz+d)*Const.D2R);for(var e=0;e<this.pt.length;e++)this.pt[e].x=this.yR[e].x+this.x,this.pt[e].y=this.yR[e].y+this.y,this.pt[e].z=this.yR[e].z+this.z}};var TankTurret=function(a){this.anc=a,this.x=a.x,this.y=a.y,this.z=a.z,this.px=this.py=0,this.dist=0,this.scale=1,this.locSc=1,this.vis=!0,this.pt=[],this.qd=[],this.uR=[],this.zR=[],this.yR=[],this.xR=[],this.rx=this.ry=this.rz=0,this.gun=null,this.init()};TankTurret.prototype={setScale:function(a){this.scale=a},init:function(){var a=addSprite(this,0,-108,16,"",50);addBox(this,0,-108,0,64,48,64,["#999","","#888","#888","#888","#888"]);for(var b=0;b<this.pt.length;b++){var c=this.pt[b].x-this.x,d=this.pt[b].y-this.y,e=this.pt[b].z-this.z;this.uR.push({x:c,y:d,z:e}),this.zR.push({x:c,y:d,z:e}),this.yR.push({x:c,y:d,z:e}),this.xR.push({x:c,y:d,z:e})}this.gun=new TankGun(a)},update:function(a,b,c,d,e){this.x=this.anc.x,this.y=this.anc.y,this.z=this.anc.z,rotate(this,(this.rx+c)*Const.D2R,(this.ry+d)*Const.D2R,(this.rz+e)*Const.D2R);for(var f=0;f<this.pt.length;f++)this.pt[f].x=this.yR[f].x+this.x,this.pt[f].y=this.yR[f].y+this.y,this.pt[f].z=this.yR[f].z+this.z;this.gun.update(b,this.rx+c,this.ry+d,this.rz+e)}};var TouchControls=function(){var a=Math.min(1680,(window.innerWidth-originX)*(1/scale)),b=Math.max(0,1/scale*(0-originX));this.left=new Button(b+125,420,80,""),this.right=new Button(b+275,420,80,""),this.up=new Button(b+200,345,80,""),this.down=new Button(b+200,495,80,""),this.confirm=new Button(a-225,420,100,"A"),this.v=isTouch,this.btns=[this.left,this.right,this.up,this.down,this.confirm]};TouchControls.prototype={click:function(a,b){this.confirm.click(a,b)&&game.action()},press:function(a,b){for(var c=0;c<this.btns.length;c++)this.btns[c].press(a,b)},release:function(){for(var a=0;a<this.btns.length;a++)this.btns[a].release()},update:function(a,b){for(var c=0;c<this.btns.length;c++)this.btns[c].update(a,b)},draw:function(){if(this.v&&!game.isMapCam&&1==game.turn)for(var a=0;a<this.btns.length;a++)this.btns[a].draw()}};var Transition=function(){this.v=!1,this.w=!1,this.p=Const.H,this.speed=60,this.isTop=!0};Transition.prototype={start:function(){this.p=Const.H,this.v=!0,this.w=!1,this.isTop=!0},onComplete:function(){this.v=!1},onHidden:function(){this.w=!0;var a=this;setTimeout(function(){a.w=!1,transFunc()},100)},update:function(){if(this.v){this.w||(this.p-=this.speed,this.p<=0&&this.isTop?(this.onHidden(),this.isTop=!1):this.p<=-1*Const.H&&this.onComplete());var a=0;this.p>0&&(a=this.p*scale),ctx.fillStyle="#000",ctx.fillRect(0,a,cv.width,(this.p+(Const.H+50))*scale)}}};var Tree=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.px=this.py=0,this.dist=0,this.scale=this.locSc=1,this.vis=!0,this.pt=[],this.qd=[],this.init(d)};Tree.prototype={setScale:function(a){this.scale=a},init:function(a){for(var b="#F58023",c=0;c<a+3;c++)addSprite(this,0,-120-20*c,0,0==c?"#42B59A":"#46BEA2",120);addBox(this,0,-35,0,40,70,40,["","",b,b,b,b]),addQuad(this,[45,0,45],[-45,0,45],[-45,0,-45],[45,0,-45],"img_shadow",-1)},update:function(){for(var a=0;a<this.qd.length;a++)for(var b=0;b<this.qd[a].length;b++)game.isLkDn?this.qd[a][b].hid=!0:this.qd[a][b].hid=!1}};var Vector2D=function(a,b){this.x=a||0,this.y=b||0};Vector2D.prototype={magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalise:function(){if(0==this.x&&0==this.y)return this;var a=this.magnitude();return this.x=this.x/a,this.y=this.y/a,this},angle:function(a){return Math.atan2(this.y,this.x)*(a?1:Const.R2D)},vector:function(a){this.x=Math.sin(a*Const.D2R),this.y=-Math.cos(a*Const.D2R)}};</script><style type="text/css">html, body{font-family: sans-serif; margin:0; width:100%; height:100%; overflow:hidden; background-color:#000; color: #fff;}#game{display:block; background-color:#000; margin-left:auto; margin-right:auto; outline:none;}#rotate{position:absolute; top: 0; left:0; width: 100%; height: 100%; display: none;}#sp{position: absolute; top: 0; left: 0; width: 100%; height: 999999px; z-index: 999999; background-color: #000;}.sp_text{text-align: center; position: absolute; top: 100px; left: 0; right: 0; font-size: 28px;}.sp_disabled .sp_text{display: none;}</style></head><body><div style="display:none"><img id="img_shadow" width="100" height="100" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20image-rendering%3D%22auto%22%20width%3D%22920%22%20height%3D%22560%22%3E%3Cpath%20d%3D%22M85%2085Q100%2071%20100%2050%20100%2029%2085%2015%2071%200%2050%200%2029%200%2015%2015%200%2029%200%2050%200%2071%2015%2085%2029%20100%2050%20100%2071%20100%2085%2085%22%20fill-opacity%3D%220.2%22%2F%3E%3C%2Fsvg%3E"></div><div id="rotate"><p class="sp_text">ROTATE YOUR DEVICE</p></div><div id="holder" class="sp_disabled"><canvas id="game" width="1680" height="720" tabindex="1"></canvas><div id="sp"><p class="sp_text">SWIPE UP TO PLAY</p></div></div><script>var swipePrompt=new SwipePrompt();</script></body></html>